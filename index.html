<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Daily Cartomancy</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Quicksand:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }
        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #e1efff 100%);
            color: #1e293b;
            overflow: hidden;
            /* Prevent bounce scroll on iOS */
            position: fixed; 
            width: 100%;
            height: 100%;
        }
        .serif { font-family: 'Cinzel', serif; }
        .glass {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        
        /* Custom Range Slider */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px;
            border-radius: 50%; background: #3b82f6; margin-top: -6px; cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; background: #cbd5e1; border-radius: 2px;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { motion, AnimatePresence, useMotionValue, useTransform } = window.Motion;

        // --- DATA ---
        const SUITS = [
            { id: 'spades', symbol: '♠', color: 'text-slate-900', name: 'Spades' },
            { id: 'hearts', symbol: '♥', color: 'text-rose-600', name: 'Hearts' },
            { id: 'clubs', symbol: '♣', color: 'text-slate-900', name: 'Clubs' },
            { id: 'diamonds', symbol: '♦', color: 'text-rose-600', name: 'Diamonds' }
        ];
        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const FORTUNE_DATABASE = [
            "A sudden change in direction brings unexpected joy.", "Old wounds begin to heal; a time of peace is near.",
            "A message from a distant friend will clarify your doubts.", "Be wary of promises that sound too good to be true.",
            "Financial stability is on the horizon, but requires discipline.", "A creative spark will lead to a new passion project.",
            "Silence is your best answer in the coming conflict.", "Travel is indicated; look to the horizon.",
            "A small kindness you do today will return tenfold.", "Beware of envy in your close circle.",
            "The answer you seek is already within you.", "A collaboration will prove more fruitful than working alone.",
            "Delay your decision until the moon is full.", "An unexpected gift arrives.",
            "Focus on your health; balance is key.", "A romantic interest surfaces in an unlikely place.",
            "Trust your intuition over logic today.", "A barrier is removed, allowing you to move forward.",
            "Someone is thinking of you with great affection.", "Let go of what you cannot control.",
            "Victory is assured if you remain patient.", "A secret will be revealed.",
            "Focus on home and family matters.", "A legal matter resolves in your favor.",
            "Inspiration strikes during the night.", "A new partnership is forming.",
            "Avoid making hasty investments.", "Your hard work is about to be recognized.",
            "Reconnect with nature to find clarity.", "A misunderstanding will be cleared up soon.",
            "Good news comes regarding a child or younger person.", "A strong older figure offers wisdom.",
            "You will soon be free of a burden.", "A celebration is in order.",
            "Watch your dreams closely; they contain messages.", "A lost item will be found.",
            "Diplomacy is required in your current situation.", "A shift in perspective changes everything.",
            "You are protected from harm.", "Prosperity flows when you open your hands.",
            "A relationship reaches a new level of understanding.", "Study or learning leads to advancement.",
            "Forgiveness is the key to your freedom.", "A surprise visit is likely.",
            "Your courage will be tested and proven.", "Harmony returns to your household.",
            "A difficult cycle is ending.", "New opportunities arise from a distinct failure.",
            "Listen to the water; it knows the way.", "Fire burns away the old to make way for the new.",
            "The earth remains solid beneath your feet.", "The wind carries your name to new places."
        ];

        // --- UTILS ---
        const seededRandom = (seed) => {
            let h = 0x811c9dc5;
            for (let i = 0; i < seed.length; i++) { h ^= seed.charCodeAt(i); h = Math.imul(h, 0x01000193); }
            return function() {
                h = Math.imul(h ^ (h >>> 16), 2246822507);
                h = Math.imul(h ^ (h >>> 13), 3266489909);
                return (h >>> 0) / 4294967296;
            }
        };

        const getDailyDivination = (suit, rank) => {
            const dateStr = new Date().toDateString(); 
            const rng = seededRandom(dateStr);
            let indices = Array.from({length: 52}, (_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(rng() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            const suitIndex = SUITS.findIndex(s => s.id === suit);
            const rankIndex = RANKS.indexOf(rank);
            const cardValue = (suitIndex * 13) + rankIndex;
            return FORTUNE_DATABASE[indices[cardValue] % FORTUNE_DATABASE.length];
        };

        // --- COMPONENTS ---

        const Icons = {
            Music: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>,
            Voice: ({ on }) => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{on ? <><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></> : <><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12"></path><path d="M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M19 10v2a7 7 0 0 1-2.9 5.68"></path><path d="M12 19a7 7 0 0 1-7-7v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></>}</svg>,
            Close: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Add: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        };

        const CardDisplay = ({ suit, rank, isSmall }) => {
            const s = SUITS.find(x => x.id === suit);
            // Responsive sizing classes
            const sizeClasses = isSmall ? "w-12 h-16 text-xs p-1" : "w-48 h-72 md:w-64 md:h-96 text-3xl p-4 md:p-6";
            
            return (
                <div className={`relative ${sizeClasses} rounded-xl md:rounded-2xl shadow-xl flex flex-col justify-between select-none bg-white border border-slate-100`}>
                    <div className={`font-bold ${s.color} flex flex-col items-center leading-none`}>
                        <span>{rank}</span>
                        <span>{s.symbol}</span>
                    </div>
                    {!isSmall && (
                        <div className="flex-grow flex items-center justify-center opacity-10">
                             <span className={`text-7xl md:text-9xl ${s.color}`}>{s.symbol}</span>
                        </div>
                    )}
                    <div className={`font-bold ${s.color} flex flex-col items-center leading-none transform rotate-180`}>
                        <span>{rank}</span>
                        <span>{s.symbol}</span>
                    </div>
                </div>
            );
        };

        const CardSelector = ({ onSelect, onClose }) => {
            const [selectedSuit, setSelectedSuit] = useState(null);
            return (
                <motion.div 
                    className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/30 backdrop-blur-md"
                    initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
                >
                    <motion.div 
                        className="glass w-full max-w-sm p-6 rounded-3xl shadow-2xl relative overflow-hidden flex flex-col max-h-[80vh]"
                        initial={{ scale: 0.9, y: 20 }} animate={{ scale: 1, y: 0 }}
                    >
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 p-2 hover:bg-slate-100 rounded-full"><Icons.Close /></button>
                        <h2 className="text-xl font-bold text-slate-700 mb-6 text-center serif">{selectedSuit ? "Select Rank" : "Select Suit"}</h2>
                        
                        <div className="flex-grow overflow-y-auto no-scrollbar">
                            {!selectedSuit ? (
                                <div className="grid grid-cols-2 gap-3">
                                    {SUITS.map(suit => (
                                        <button key={suit.id} onClick={() => setSelectedSuit(suit)} className="h-28 rounded-2xl bg-white/50 hover:bg-white flex flex-col items-center justify-center gap-1 border border-transparent hover:border-slate-200">
                                            <span className={`text-4xl ${suit.color}`}>{suit.symbol}</span>
                                            <span className="text-slate-500 text-sm font-medium">{suit.name}</span>
                                        </button>
                                    ))}
                                </div>
                            ) : (
                                <div className="grid grid-cols-4 gap-2">
                                    {RANKS.map(rank => (
                                        <button key={rank} onClick={() => onSelect(selectedSuit.id, rank)} className="aspect-square rounded-xl bg-white/50 hover:bg-white text-slate-700 font-bold text-lg border border-transparent hover:border-slate-200">
                                            {rank}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                        {selectedSuit && (
                            <button onClick={() => setSelectedSuit(null)} className="mt-4 w-full py-3 rounded-xl bg-slate-200 text-slate-600 font-medium text-sm">Back</button>
                        )}
                    </motion.div>
                </motion.div>
            );
        };

        // --- DOCK ITEM COMPONENT ---
        const DockItem = ({ item, isActive, onClick, mouseX }) => {
            const elRef = useRef(null);
            // Calculate distance from mouse for wave effect
            const distance = useTransform(mouseX, (val) => {
                const bounds = elRef.current?.getBoundingClientRect() ?? { x: 0, width: 0 };
                return val - bounds.x - bounds.width / 2;
            });
            
            // Map distance to scale (Desktop Wave Effect)
            const scaleSync = useTransform(distance, [-100, 0, 100], [1, 1.4, 1]);
            
            return (
                <motion.button 
                    ref={elRef}
                    onClick={onClick}
                    style={{ scale: scaleSync }}
                    className={`relative flex-shrink-0 transition-all duration-300 ${isActive ? 'z-10' : 'z-0 opacity-70 hover:opacity-100'}`}
                    animate={isActive ? { y: -15, scale: 1.2 } : { y: 0 }}
                >
                    <CardDisplay suit={item.suit} rank={item.rank} isSmall={true} />
                    {isActive && <motion.div layoutId="dot" className="absolute -bottom-3 left-0 right-0 h-1 bg-blue-400 rounded-full" />}
                </motion.button>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            // State
            const [history, setHistory] = useState([]);
            const [currentCardId, setCurrentCardId] = useState(null);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [isWelcome, setIsWelcome] = useState(true);
            const [musicVolume, setMusicVolume] = useState(0.5);
            const [isMusicMuted, setIsMusicMuted] = useState(false);
            const [showMusicControls, setShowMusicControls] = useState(false);
            const [isVoiceEnabled, setIsVoiceEnabled] = useState(true);

            // Refs & Motion
            const bgMusicRef = useRef(null);
            const voiceRef = useRef(null);
            const mouseX = useMotionValue(null);

            // Init
            useEffect(() => {
                const saved = localStorage.getItem('cartomancyHistory');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (parsed.length > 0) {
                        setHistory(parsed);
                        setCurrentCardId(parsed[parsed.length - 1].id);
                        setIsWelcome(false);
                    }
                }
            }, []);
            
            useEffect(() => localStorage.setItem('cartomancyHistory', JSON.stringify(history)), [history]);

            // Audio Logic
            useEffect(() => { if (bgMusicRef.current) bgMusicRef.current.volume = isMusicMuted ? 0 : musicVolume; }, [musicVolume, isMusicMuted]);
            
            const currentCard = useMemo(() => history.find(c => c.id === currentCardId), [history, currentCardId]);
            const currentIndex = useMemo(() => history.findIndex(c => c.id === currentCardId), [history, currentCardId]);

            useEffect(() => {
                if (voiceRef.current) { voiceRef.current.pause(); voiceRef.current.currentTime = 0; }
                if (currentCard && isVoiceEnabled) {
                    const idx = FORTUNE_DATABASE.indexOf(currentCard.divination);
                    if (idx !== -1) {
                        voiceRef.current.src = `assets/audio/DC_${idx + 1}.wav`;
                        setTimeout(() => { if(isVoiceEnabled) voiceRef.current.play().catch(() => {}); }, 500);
                    }
                }
            }, [currentCardId, isVoiceEnabled, currentCard]);

            // Handlers
            const handleStart = () => {
                setIsMenuOpen(true);
                if (bgMusicRef.current?.paused) bgMusicRef.current.play().catch(() => {});
            };

            const handleCardSelect = (suit, rank) => {
                const divination = getDailyDivination(suit, rank);
                const newCard = { id: Date.now(), suit, rank, divination };
                setHistory(prev => [...prev, newCard]);
                setCurrentCardId(newCard.id);
                setIsMenuOpen(false);
                setIsWelcome(false);
            };

            const handleSwipe = (event, info) => {
                if (history.length < 2) return;
                const threshold = 50;
                if (info.offset.x > threshold && currentIndex > 0) {
                    setCurrentCardId(history[currentIndex - 1].id); // Swipe Right -> Prev
                } else if (info.offset.x < -threshold && currentIndex < history.length - 1) {
                    setCurrentCardId(history[currentIndex + 1].id); // Swipe Left -> Next
                }
            };

            return (
                <div 
                    className="h-screen w-full flex flex-col relative"
                    onClick={() => setShowMusicControls(false)}
                    onMouseMove={(e) => mouseX.set(e.pageX)}
                    onMouseLeave={() => mouseX.set(null)}
                >
                    <audio ref={bgMusicRef} src="assets/audio/Daily Cartomancy.mp3" loop={false} />
                    <audio ref={voiceRef} />

                    {/* Top Bar (Safe Area Aware) */}
                    <header className="pt-[max(1rem,env(safe-area-inset-top))] px-4 pb-2 flex justify-between items-center z-20 w-full max-w-lg mx-auto">
                        <button onClick={() => {setHistory([]); setIsWelcome(true); setCurrentCardId(null);}} className="text-[10px] text-slate-400 font-bold uppercase tracking-widest p-2 hover:text-red-400">Reset</button>
                        <h1 className="text-lg font-bold serif text-slate-700">Daily Cartomancy</h1>
                        <div className="flex items-center gap-2 relative">
                            <button onClick={(e) => { e.stopPropagation(); setIsVoiceEnabled(!isVoiceEnabled); }} className={`p-2 ${isVoiceEnabled ? 'text-slate-700' : 'text-slate-300'}`}><Icons.Voice on={isVoiceEnabled} /></button>
                            <button onClick={(e) => { e.stopPropagation(); setShowMusicControls(!showMusicControls); }} className={`p-2 ${!isMusicMuted ? 'text-slate-700' : 'text-slate-300'}`}><Icons.Music /></button>
                            {showMusicControls && (
                                <div onClick={(e) => e.stopPropagation()} className="absolute right-0 top-12 glass p-3 rounded-xl shadow-xl w-40 z-50">
                                    <input type="range" min="0" max="1" step="0.01" value={musicVolume} onChange={(e) => {setMusicVolume(parseFloat(e.target.value)); setIsMusicMuted(false);}} className="w-full" />
                                </div>
                            )}
                        </div>
                    </header>

                    {/* Main Stage */}
                    <main className="flex-grow flex flex-col items-center justify-center relative w-full overflow-hidden">
                        <AnimatePresence mode="wait">
                            {isWelcome ? (
                                <motion.div key="welcome" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="text-center p-6">
                                    <p className="text-slate-500 mb-8 font-light text-lg">Pull a card from your deck.<br/>Let the day reveal its meaning.</p>
                                    <button onClick={handleStart} className="px-8 py-4 bg-white text-slate-800 rounded-full shadow-lg font-bold flex items-center gap-2 mx-auto active:scale-95 transition-transform">
                                        <span>Enter Card</span>
                                        <span className="text-blue-500">→</span>
                                    </button>
                                </motion.div>
                            ) : (
                                currentCard && (
                                    <motion.div 
                                        key={currentCard.id}
                                        className="w-full max-w-md flex flex-col items-center gap-6 px-4"
                                        initial={{ opacity: 0, scale: 0.95 }}
                                        animate={{ opacity: 1, scale: 1 }}
                                        exit={{ opacity: 0, scale: 0.95 }}
                                        transition={{ type: "spring", bounce: 0.2 }}
                                    >
                                        <motion.div 
                                            drag="x" 
                                            dragConstraints={{ left: 0, right: 0 }}
                                            dragElastic={0.2}
                                            onDragEnd={handleSwipe}
                                            className="cursor-grab active:cursor-grabbing touch-pan-y"
                                        >
                                            <CardDisplay suit={currentCard.suit} rank={currentCard.rank} />
                                        </motion.div>
                                        
                                        <div className="glass p-5 rounded-2xl w-full text-center min-h-[100px] flex items-center justify-center">
                                            <p className="text-slate-800 text-base md:text-lg font-medium serif leading-relaxed">"{currentCard.divination}"</p>
                                        </div>
                                    </motion.div>
                                )
                            )}
                        </AnimatePresence>
                    </main>

                    {/* Footer Dock (Safe Area Aware) */}
                    <div className="pb-[max(1rem,env(safe-area-inset-bottom))] px-4 w-full z-10">
                        {!isWelcome && history.length > 0 && (
                            <div className="glass rounded-2xl p-2 mx-auto max-w-2xl flex items-end gap-1 relative">
                                <button onClick={() => setIsMenuOpen(true)} className="w-12 h-16 rounded-lg bg-blue-500/10 text-blue-500 flex items-center justify-center hover:bg-blue-500/20 transition-colors mr-2 mb-[1px]">
                                    <Icons.Add />
                                </button>
                                <div className="h-8 w-px bg-slate-300 mx-1 mb-4"></div>
                                
                                {/* The Dock Scroller */}
                                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1 px-1 items-end mask-linear w-full h-24">
                                    {history.map(item => (
                                        <DockItem 
                                            key={item.id} 
                                            item={item} 
                                            isActive={item.id === currentCardId} 
                                            onClick={() => setCurrentCardId(item.id)}
                                            mouseX={mouseX}
                                        />
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    <AnimatePresence>
                        {isMenuOpen && <CardSelector onClose={() => setIsMenuOpen(false)} onSelect={handleCardSelect} />}
                    </AnimatePresence>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
